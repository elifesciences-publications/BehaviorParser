classdef ZxOptoExample < handle    methods (Static)        function plot()            fstr=load('ZxOptoExample.mat');            perf8=fstr.perf8;            figure('Color','w','Position',[100,100,170,180]);            hold on;            ZxOptoExample.plotOne([2,1],perf8(perf8(:,3)==0,1:2),'k');            ZxOptoExample.plotOne([4,3]+1,perf8(perf8(:,3)==1,1:2),'b');            set(gca,'XTick',[1 2 4 5],'XTickLabel',{'off','on','off','on'},'FontSize',10,'YTick',60:20:100);            xlim([0,6]);            ylim([55,100]);ylabel('Correct Rate (%)','FontSize',10);            print('-depsc','-painters','-r0','perf8s.eps');            print('-dpng','-painters','-r0','perf8s.png');            print('-dmeta','-painters','-r0','perf8s.emf');                        [efc8,efo8]=ZxOptoExample.cohen_s_d(perf8(perf8(:,3)==0,1),perf8(perf8(:,3)==0,2),perf8(perf8(:,3)==1,1),perf8(perf8(:,3)==1,2));            ranovatbl=ZxOptoExample.mixedRanova(perf8(perf8(:,3)==0,1),perf8(perf8(:,3)==0,2),perf8(perf8(:,3)==1,1),perf8(perf8(:,3)==1,2));            pairPermP=[ZxOptoExample.pairedPermTest(perf8(perf8(:,3)==0,1),perf8(perf8(:,3)==0,2)),...                ZxOptoExample.pairedPermTest(perf8(perf8(:,3)==1,1),perf8(perf8(:,3)==1,2))];            delete('stats.html');            diary('stats.html');            type('header.txt');            ZxOptoExample.elifeFormatPrefix('DNMS task, 8s delay, correct rate',efc8,efo8);            ZxOptoExample.elifeFormatMid();            disp(ranovatbl(:,1:5));            ZxOptoExample.elifeFormatPostfix(pairPermP);            diary off;            hold off;        end    end    methods (Static, Access=private)        function plotOne(x,y,pColor)            dd=0.5;            randd=@(x) rand(size(x,1),1)*0.5-0.25;            plot((x+randd(y))',y',sprintf('-%s.',pColor));                        ci=bootci(1000,@(x) nanmean(x), y(:,2));            plot([x(2)-dd,x(2)-dd],ci,sprintf('-%s',pColor),'LineWidth',1);            ci=bootci(1000,@(x) nanmean(x), y(:,1));            plot([x(1)+dd,x(1)+dd],ci,sprintf('-%s',pColor),'LineWidth',1);                        plot(x(2)-dd,nanmean(y(:,2)),sprintf('%so',pColor),'MarkerFaceColor','w','MarkerSize',4,'LineWidth',1);            plot(x(1)+dd,nanmean(y(:,1)),sprintf('%so',pColor),'MarkerFaceColor',pColor,'MarkerSize',4,'LineWidth',1);        end                function elifeFormatMid()            fprintf('<tr><td>Mixed-between-within-ANOVA</td><td colspan=3><pre>');        end        function elifeFormatPostfix(pairedPermP)                        fprintf('</pre></td></tr>');            fprintf('<tr><td width="25%%">Post-hoc paired permutation test, p, control</td><td width="25%%">%.3f</td><td width="25%%">Post-hoc paired permutation test, p, ChR2</td><td width="25%%">%.3f</td></tr>\n',pairedPermP(1),pairedPermP(2));            fprintf('</table>\n');        end        function elifeFormatPrefix(s1,efc,efo)            fprintf('<br/><table><tr><th colspan=4>%s</th></tr>\n',s1);            fprintf('<tr><td width="25%%">Effect size (Cohen''s d), control</td><td width="25%%">%.3f</td><td width="25%%">Effect size (Cohen''s d), ChR2</td><td width="25%%">%.3f</td></tr>\n',efc,efo);        end                function [effCtrl,effOpto]=cohen_s_d(ctrlOff,ctrlOn,optoOff,optoOn)            nCtrl=numel(ctrlOff)-1;            sCtrl=sqrt((nCtrl*var(ctrlOff)+nCtrl*var(ctrlOn))/(2*nCtrl));            nOpto=numel(optoOff)-1;            sOpto=sqrt((nOpto*var(optoOff)+nOpto*var(optoOn))/(2*nOpto));            effCtrl=(mean(ctrlOff)-mean(ctrlOn))/sCtrl;            effOpto=(mean(optoOff)-mean(optoOn))/sOpto;        end        function ranovatbl=mixedRanova(ctrlOff,ctrlOn,optoOff,optoOn)                        perfT=table(num2str([zeros(numel(ctrlOff),1);ones(numel(optoOff),1)]),...                [ctrlOff;optoOff],...                [ctrlOn;optoOn],...                'VariableNames',{'Genotype',...                'LaserOff','LaserOn'                });            opto=table(num2str((1:2).'),'VariableNames',{'OptoCondition'});                        RAMDL=fitrm(perfT,'LaserOff,LaserOn~Genotype','WithinDesign',opto);            [ranovatbl,~,~,~]=ranova(RAMDL,'WithinModel','OptoCondition');        end                function p=pairedPermTest(A,B)            p=mean(arrayfun(@(x) abs(((rand(1,numel(A))>0.5).*2-1)*(A(:)-B(:)))./numel(A)>=abs(mean(A(:)-B(:))),1:10000));%             currDelta=abs(mean(A(:)-B(:)));%             permed=nan(1,10000);%             for i=1:10000%                 permed(i)=abs(((rand(1,numel(A))>0.5).*2-1)*(A(:)-B(:)))./numel(A);%             end%             p=mean(permed>=currDelta);        end    endend